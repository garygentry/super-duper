<Page
    x:Class="SuperDuper.Views.GroupsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SuperDuper.Views"
    xmlns:vm="using:SuperDuper.ViewModels"
    xmlns:models="using:SuperDuper.Models">

    <Grid Padding="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header: title + sort + filters -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                       Text="Duplicate Groups"
                       Style="{StaticResource TitleLargeTextBlockStyle}"
                       VerticalAlignment="Center" />

            <!-- Sort selector -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="0,0,8,0">
                <TextBlock Text="Sort:"
                           VerticalAlignment="Center"
                           Style="{StaticResource BodyTextBlockStyle}" />
                <ComboBox x:Name="SortCombo"
                          SelectedIndex="0"
                          MinWidth="160"
                          SelectionChanged="SortCombo_SelectionChanged">
                    <ComboBoxItem Content="Wasted Space" Tag="wasted_bytes" />
                    <ComboBoxItem Content="File Size" Tag="file_size" />
                    <ComboBoxItem Content="Copy Count" Tag="file_count" />
                    <ComboBoxItem Content="Filename" Tag="file_name" />
                </ComboBox>
            </StackPanel>

            <!-- Auto-Select split button -->
            <SplitButton Grid.Column="2"
                         Content="Auto-Select"
                         Click="AutoSelect_Click">
                <SplitButton.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Keep Newest" Click="AutoSelectKeepNewest_Click" />
                        <MenuFlyoutItem Text="Keep Shortest Path" Click="AutoSelectKeepShortest_Click" />
                    </MenuFlyout>
                </SplitButton.Flyout>
            </SplitButton>
        </Grid>

        <!-- Filter chips bar -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
            <Button Content="+ Filter"
                    Click="AddFilter_Click"
                    FontSize="12" />
            <ItemsRepeater x:Name="FilterChipsRepeater"
                           ItemsSource="{x:Bind ViewModel.ActiveFilters}">
                <ItemsRepeater.Layout>
                    <StackLayout Orientation="Horizontal" Spacing="6" />
                </ItemsRepeater.Layout>
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate x:DataType="models:FilterChip">
                        <Button Content="{x:Bind DisplayLabel}"
                                Tag="{x:Bind}"
                                Click="FilterChip_Remove"
                                FontSize="12"
                                Padding="8,4" />
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </StackPanel>

        <!-- Group list with ItemsRepeater for virtualization -->
        <ScrollViewer Grid.Row="2">
            <StackPanel Spacing="1">
                <ItemsRepeater x:Name="GroupsRepeater"
                               ItemsSource="{x:Bind ViewModel.Groups}">
                    <ItemsRepeater.Layout>
                        <StackLayout Spacing="4" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="vm:GroupViewModel">
                            <Expander IsExpanded="{x:Bind IsExpanded, Mode=TwoWay}"
                                      HorizontalAlignment="Stretch"
                                      HorizontalContentAlignment="Stretch">
                                <Expander.Header>
                                    <Grid ColumnSpacing="12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="64" />
                                        </Grid.ColumnDefinitions>

                                        <!-- File type icon -->
                                        <FontIcon Grid.Column="0"
                                                  Glyph="&#xE7C3;"
                                                  FontSize="16"
                                                  VerticalAlignment="Center" />

                                        <!-- Filename -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{x:Bind SampleFileName}"
                                                   Style="{StaticResource BodyStrongTextBlockStyle}"
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis" />

                                        <!-- Copy count badge -->
                                        <Border Grid.Column="2"
                                                Background="{ThemeResource AccentFillColorDefaultBrush}"
                                                CornerRadius="10" Padding="6,2"
                                                VerticalAlignment="Center">
                                            <TextBlock Foreground="White" FontSize="11">
                                                <Run Text="Ã—" /><Run Text="{x:Bind FileCount}" />
                                            </TextBlock>
                                        </Border>

                                        <!-- File size -->
                                        <TextBlock Grid.Column="3"
                                                   Text="{x:Bind FormattedFileSize}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   VerticalAlignment="Center" />

                                        <!-- Wasted space -->
                                        <TextBlock Grid.Column="4"
                                                   Text="{x:Bind FormattedWastedBytes}"
                                                   Foreground="{ThemeResource DeleteBrush}"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   VerticalAlignment="Center" />

                                        <!-- Review status badge -->
                                        <Border Grid.Column="5"
                                                CornerRadius="4" Padding="6,2"
                                                Background="{x:Bind ReviewStatusBackground}"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{x:Bind ReviewStatusLabel}"
                                                       FontSize="11" />
                                        </Border>
                                    </Grid>
                                </Expander.Header>

                                <!-- Expanded: per-copy rows -->
                                <ItemsRepeater ItemsSource="{x:Bind Files}">
                                    <ItemsRepeater.Layout>
                                        <StackLayout Spacing="2" />
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate x:DataType="vm:GroupFileViewModel">
                                            <Grid ColumnSpacing="8" Padding="8,4"
                                                  Background="{ThemeResource ControlAltFillColorSecondaryBrush}">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="8" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="24" />
                                                </Grid.ColumnDefinitions>

                                                <!-- Drive color stripe -->
                                                <Rectangle Grid.Column="0"
                                                           Fill="{x:Bind DriveColorBrush}"
                                                           RadiusX="2" RadiusY="2" />

                                                <!-- Full path -->
                                                <TextBlock Grid.Column="1"
                                                           Text="{x:Bind CanonicalPath}"
                                                           Style="{StaticResource PathTextStyle}"
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center" />

                                                <!-- Modified date -->
                                                <TextBlock Grid.Column="2"
                                                           Text="{x:Bind LastModified}"
                                                           Style="{StaticResource CaptionTextBlockStyle}"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                           VerticalAlignment="Center" />

                                                <!-- K/D/S buttons -->
                                                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="2">
                                                    <Button Content="Keep"
                                                            FontSize="11" Padding="8,4"
                                                            Foreground="{ThemeResource KeepBrush}"
                                                            Command="{x:Bind SetKeepCommand}"
                                                            AutomationProperties.Name="{x:Bind KeepAccessibleName}" />
                                                    <Button Content="Delete"
                                                            FontSize="11" Padding="8,4"
                                                            Foreground="{ThemeResource DeleteBrush}"
                                                            Command="{x:Bind SetDeleteCommand}"
                                                            AutomationProperties.Name="{x:Bind DeleteAccessibleName}" />
                                                    <Button Content="Skip"
                                                            FontSize="11" Padding="8,4"
                                                            Foreground="{ThemeResource SkipBrush}"
                                                            Command="{x:Bind SetSkipCommand}"
                                                            AutomationProperties.Name="{x:Bind SkipAccessibleName}" />
                                                </StackPanel>

                                                <!-- Reveal button -->
                                                <Button Grid.Column="4"
                                                        Command="{x:Bind RevealCommand}"
                                                        ToolTipService.ToolTip="Reveal in Explorer"
                                                        Background="Transparent" BorderThickness="0"
                                                        AutomationProperties.Name="Reveal in File Explorer">
                                                    <FontIcon Glyph="&#xEC50;" FontSize="14" />
                                                </Button>

                                                <!-- Decision indicator -->
                                                <FontIcon Grid.Column="6"
                                                          Glyph="{x:Bind DecisionGlyph}"
                                                          FontSize="14"
                                                          Foreground="{x:Bind DecisionBrush}"
                                                          VerticalAlignment="Center" />
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </Expander>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>

                <!-- Load more -->
                <Button Content="Load More"
                        HorizontalAlignment="Center"
                        Margin="0,12"
                        Command="{x:Bind ViewModel.LoadMoreCommand}"
                        Visibility="{x:Bind ViewModel.HasMore, Mode=OneWay}" />
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
